---
title: "predictions"
author: "Michael Fedell"
date: "12/1/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source('./LinearModel/linear-model.R', chdir = T)
source('./LogisticModel/logistic-model.R', chdir = T)
```

# Model Results

The logistic regression and mulitple linear regression models willbe combined together to come up with a predicted response for each customer in the test set.

This will be done by first predicting the customer's liklihood to respond to the promotion via the logistic regression model. After determining response liklihood, the mulitple linear regression will be applied to predict how _much_ a customer will purchase after the promotion.

In summary: E(logtargamt) = P(logtargamt > 0) * E(logtargamt | logtargamt > 0)

## Logistic Regression

The logisitc model was developed by fitting a binomial generalized linear model to the test data set using a collection of predictors both natural and engineered. The predictors used in the final model are as follows:

- avgNetOrder: average amount of money each customer ever spend
- sumQty: The total quantity each customer ordered
- recency: no. of days since the last order
- frequency: number of orders
- tof: each customer's time on file
- amountPer: total past purchase amount/time on file 
- oneMonth: dummy variable- 1 if the customer placed order within one month prior to 08/01/2014
- threeMonth: dummy variable- 1 if the customer placed order within three month prior to 08/01/2014
- overYear: dummy variable- 1 if the customer placed order over one year prior to 08/01/2014
- sumQtyPerTof: frequnecy of placing orders


## Multiple Regression

The mulitple linear regression was produced by several iterations of feature engineering and model variation. Ultimately, a best model was obtained via stepwise regression allowed to move in both forward and backward directions. The final predictors used are as follows:

- recency: no. of days since the last order
- frequency: number of orders
- amount:total past purchase amount in euros
- amountPer: total past purchase amount/time on file 
- sumQty: The total quantity each customer ordered
- oneMonth: dummy variable- 1 if the customer placed order within one month prior to 08/01/2014


## Synthesis

These two models will be brought together to form predictions on the expected amount purchased for customers in the test set.

We will narrow down the full test data to just the needed variables, while also filtering out several of the significant outliers (with more than 1000 orders)

```{r}
predictions <- test.full %>%
  select(avgNetOrder, sumQty, recency, frequency, tof, amount,
         amountPer, oneMonth, threeMonth, oneYear, sumQtyPerTof,
         logtargamt) %>% filter(tof > 0, sumQty < 1000)
```

The predictions given by the logistic regression are biased towards responders becuase the training data was oversampled to better balance responses. This bias will be corrected below

```{r}
p2 <- predict(log.best, newdata = predictions, type = 'response')
m <- nrow(filter(train.rebalanced, respond == 1)) / nrow(train.rebalanced) / .0393
p1 <- exp(-log(m) + log(p2 / (1 - p2)))/(1 + exp(-log(m) + log(p2 / (1 - p2))))

predictions$probRespond <- p1
```

The multiple regression can now be applied to the set to predict the amount purchased. These predictions will be scaled by the customer's liklihood to respond to offer (as calculated by logistic regression).

```{r}
predictions$predLogtargamt <- predict(ml.best, newdata = predictions)
predictions$scaledLogtargamt <- predictions$probRespond * predictions$predLogtargamt
```

The predicted logtargamts must now be transformed back to a normal, predicted amount in Euros by performing the inverse of the original log transformation ($ln(amt + 1)$)

```{r}
predictions$predTargamt <- exp(predictions$scaledLogtargamt) - 1
predictions$targamt <- exp(predictions$logtargamt) - 1
```

```{r}
SSEP <- sum((predictions$predTargamt - predictions$targamt)^2); SSEP
```

