---
title: "Tova’s Log- Sophie’s Clean"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



##new book here becomes of length 8,311 because we got rid of NA's, so it's the length of the training set (test set shows as NA)
##added after variable to indicate if they purchased after the promotion
```{r}
new_bookSE <- book[!is.na(book$logtargamt),]
new_bookSE <- subset(new_bookSE, select = c(id, logtargamt, recency, frequency, amount, tof))
new_bookSE$after <- ifelse(new_bookSE$logtargamt > 0, 1, 0)
new_bookSE$ordersPer <-  new_bookSE$frequency / new_bookSE$tof
new_bookSE$amountPer <- new_bookSE$amount/ new_bookSE$tof
new_bookSE$rf <- new_bookSE$recency * new_bookSE$frequency
new_bookSE$af <- new_bookSE$amount * new_bookSE$frequency
```


## respond training which is the training set and book
```{r}
mergedTRAINse<- merge(new_bookSE, train, by="id")
resptrainingSE <-mergedTRAINse[ which (mergedTRAINse$logtargamt.x>0), ]
resptrainingSE
```

##very basic regression - R squared is 0.2465 - only on responding book set data
```{r}
resptrainingSE
targ <- lm(logtargamt.x ~  frequency + amount + amountPer, data=resptrainingSE)
summary(targ)
```




#creating dummy variables for order dates within specific time frames 
```{r}
ordersSE <- orders[which(orders$qty<1000), ]
ordersSE$returned <- ifelse(ordersSE$price== 0, 1, 0)

new_bookSE[is.na(new_bookSE)] <- 0
mergedOrdersBookSE <- merge(new_bookSE, ordersSE, by="id")

startDate <- "01-Aug-14"
ndate1 <- as.Date(startDate, "%d-%B-%y")
mergedOrdersBookSE$orddate <- as.Date(mergedOrdersBookSE$orddate , "%d-%B-%y")
mergedOrdersBookSE$dateDiff <- as.numeric(difftime(ndate1, mergedOrdersBookSE$orddate), units="days")
mergedOrdersBookSE$oneMonth <- ifelse(mergedOrdersBookSE$dateDiff < 31 , 1, 0)
mergedOrdersBookSE$threeMonth <- ifelse(mergedOrdersBookSE$dateDiff < 63 & mergedOrdersBookSE$dateDiff >31, 1, 0)
mergedOrdersBookSE$sixMonth <- ifelse(mergedOrdersBookSE$dateDiff > 63 & mergedOrdersBookSE$dateDiff <183 , 1, 0)
mergedOrdersBookSE$oneYr <- ifelse(mergedOrdersBookSE$dateDiff > 182 & mergedOrdersBookSE$dateDiff < 365 , 1, 0)
mergedOrdersBookSE$twoYr <- ifelse(mergedOrdersBookSE$dateDiff > 365 & mergedOrdersBookSE$dateDiff < 730 , 1, 0)
mergedOrdersBookSE$pastTwo <-  ifelse(mergedOrdersBookSE$dateDiff > 730 , 1, 0)
mergedOrdersBookSE
```


##sum the quantity as predictor
## grouping by id and finding max for the mergedOrdersBook set - 8,224 obs
## used max so it takes the dummy variables as they are instead of summing/mean
## responding of this data frame is only 280 before taking care of outliers
```{r}
df <- aggregate(mergedOrdersBookSE$qty, by=list(id=mergedOrdersBookSE$id), FUN=sum)
mergedOrdersBookSE <- merge(mergedOrdersBookSE, df, by="id")
resultSE <- mergedOrdersBookSE %>%
  group_by(id) %>%
  summarise_all(funs(max))
resultSE
```


```{r}
#recency
train_final2SE = subset(resultSE, resultSE$recency >= mean(resultSE$recency) - 3*sd(resultSE$recency) & resultSE$recency <= mean(resultSE$recency) +3*sd(resultSE$recency))
train_final2SE
#frequency
train_final3SE = subset(train_final2SE, train_final2SE$frequency >= mean(train_final2SE$frequency) - 3*sd(train_final2SE$frequency) & train_final2SE$frequency <= mean(train_final2SE$frequency) +3*sd(train_final2$frequency))
#amount
train_final4SE = subset(train_final3SE, train_final3SE$amount >= mean(train_final3SE$amount) - 3*sd(train_final3SE$amount) & train_final3SE$amount <= mean(train_final3SE$amount) +3*sd(train_final3SE$amount))
#refine final train
train_finalSE = train_final4SE
finalOrdBookRespSE <- train_finalSE[ which (train_finalSE$logtargamt>0), ]
finalOrdBookRespSE
```



#baseline regression with all of the variables
```{r}
baseline <- lm(logtargamt ~ recency + frequency + amount + tof + rf + af+ ordersPer + amountPer + qty + price + returned + oneMonth + threeMonth + sixMonth + oneYr+ twoYr + pastTwo, data=finalOrdBookRespSE)
summary(baseline)
plot(baseline, which = 4)
```



#Ends up at this model - R sq of 0.217 and adj of 0.199
```{r}
trySE <- lm(logtargamt ~ recency + frequency + amount   + amountPer + price  + oneMonth  , data=finalOrdBookRespSE)
summary(trySE)
```




